## Goal: Implement the `SandboxManager` for Docker

Implement the `SandboxManager` class responsible for managing the lifecycle (create, start, stop, remove) of sandbox Docker containers based on `AppDefinition` pool configurations and handling allocation requests. References Section 3.2 [18].

**Context:**
*   Data Models: `@core/shared/data_models.py` (especially `AppDefinition`, `SandboxPoolConfig`)
*   `ApplicationRegistryInterface`: `@core/interfaces/application_registry_interface.py` (to get pool configs)
*   Design Docs: Section 3.2 [18], `08-security.md` [11, 25] (resource limits, networking)
*   Project Standards: `@.clinerules` (async, logging, error handling)

**Plan:**

1.  **Add Dependencies:** Use `execute_command` to add `docker` (Python Docker SDK) to `requirements.txt` and install.
2.  **Create Implementation File:** Use `write_to_file` to create `core/sandbox/sandbox_manager.py`.
3.  **Import Dependencies:** Import `docker`, `asyncio`, `logging`, `AppDefinition`, `SandboxPoolConfig`, `ApplicationRegistryInterface`, `Optional`, `Dict`, `List`. Use `docker.from_env()` to get the client (or allow configuration).
4.  **Define `SandboxManager` Class:** Create the `SandboxManager` class.
    *   **Initialization (`__init__`)**:
        *   Accept `ApplicationRegistryInterface` instance as dependency.
        *   Initialize Docker client (`docker.from_env()`). Check Docker connection.
        *   Initialize internal state to track active pools and containers (e.g., `_pools: Dict[str, Dict]`, `_containers: Dict[str, docker.models.containers.Container]`).
        *   Initialize a logger compliant with `.clinerules`.
    *   **Core Management Methods (Likely Async Wrappers around Docker SDK):**
        *   `_start_sandbox_instance(pool_config: SandboxPoolConfig) -> Optional[docker.models.containers.Container]`:
            *   Uses `docker.containers.run()` in detached mode (`detach=True`).
            *   Pass `image=pool_config.imageUri`.
            *   Set environment variables (e.g., `UHLP_MCP_ENDPOINT`, `UHLP_APP_ID`, `UHLP_SANDBOX_PORT`).
            *   Apply resource limits (CPU, memory) based on `pool_config` or defaults, referencing `08-security.md` [11, 25].
            *   Configure networking (e.g., connect to a specific Docker network). Reference `08-security.md` [11, 25].
            *   Handle Docker errors during creation/start. Log actions and errors. Return the container object or `None`.
        *   `_stop_sandbox_instance(container: docker.models.containers.Container)`: Call `container.stop()`, handle errors, log.
        *   `_remove_sandbox_instance(container: docker.models.containers.Container)`: Call `container.remove()`, handle errors, log.
    *   **Pool Management Methods (Called periodically or on demand):**
        *   `manage_pools()`: Iterates through applications from `ApplicationRegistry`, gets their `SandboxPoolConfig`s. For each pool, checks current running instances vs. `minInstances`/`maxInstances`. Starts/stops instances using helper methods to meet requirements. Handles errors. Logs actions. Needs to run asynchronously/periodically.
    *   **Allocation API Methods:**
        *   `allocate_sandbox(app_id: str, pool_name: str) -> Optional[Dict]`:
            *   Finds an available, running container for the specified pool. (Requires tracking container state/availability).
            *   If none available and below `maxInstances`, potentially start one (`_start_sandbox_instance`) and wait (consider timeout).
            *   If allocated, mark container as 'busy'.
            *   Return details needed by `RequestRouter` (e.g., container IP/port).
            *   Handle pool not found, no available instance errors. Log actions.
        *   `release_sandbox(container_id: str)`: Mark the container associated with `container_id` as 'available' again. Log action.
5.  **Add Basic Unit Tests:** Use `write_to_file` to create `tests/core/sandbox/test_sandbox_manager.py`.
    *   Use `pytest` and mocking (`unittest.mock`).
    *   Mock the `docker` client extensively (e.g., `docker.from_env`, `client.containers.run`, `client.containers.list`, container objects and methods).
    *   Mock `ApplicationRegistryInterface`.
    *   Test allocation logic (finding existing, starting new, none available).
    *   Test release logic.
    *   Test basic pool management logic (scaling up/down based on mock container lists).

**Expected Outcome:**
*   `core/sandbox/sandbox_manager.py` containing the `SandboxManager` implementation.
*   `tests/core/sandbox/test_sandbox_manager.py` containing basic unit tests using mocks.
*   Updated dependency file.