## Goal: Implement the `core.testing.runPytestInSandbox` MCP Tool

Implement the MCP tool handler responsible for executing pytest unit tests (generated alongside JIT code) within a sandbox environment. This is crucial for the JIT optimization flow.

**Context:**
*   MCP Server Code: `@mcp_servers/core/server.py`
*   Dependencies: `SandboxManager` (to get a sandbox), `StateManagerInterface` (potentially to fetch code/tests if not mounted), `core.linux.executeCommand` handler logic (to run pytest).
*   Design Docs: `07-jit-optimization.md` [10] (requires test execution), `09-testing.md` [12] (JIT testing standards).
*   Project Standards: `@.clinerules`

**Plan:**

1.  **Define Tool Schemas:** Use `write_to_file` to create schemas in `@mcp_servers/core/schemas/`:
    *   `core.testing.runPytestInSandbox.input.schema.json`: Requires `appId` (in context), `test_file_path` (string, path in state repo), `target_pool_name` (string, name of JIT pool). Optionally `code_file_path` if code isn't co-located.
    *   `core.testing.runPytestInSandbox.output.schema.json`: Requires `success` (boolean), `output` (string, containing pytest stdout/stderr), optional `error` fields.
2.  **Read MCP Server Code:** Use `read_file` to load `@mcp_servers/core/server.py`.
3.  **Implement Handler Function:**
    *   Define `async def handle_run_pytest_in_sandbox(params, state_manager, app_registry, context)` (ensure `sandbox_manager` is also passed as a dependency here).
    *   Extract `app_id` from `context`, `test_file_path`, `target_pool_name` from `params`.
    *   **Allocate Target Sandbox:** Call `sandbox_manager.allocate_sandbox(app_id, target_pool_name)`. Handle allocation errors (raise MCPError).
    *   **Prepare Test Execution:**
        *   **Determine Paths:** Construct the *mounted path* within the sandbox corresponding to the `test_file_path` provided (this depends on how volumes are mounted by `SandboxManager` - assume a mount like `/state/<app_id>/...`). *Crucially document this path mapping assumption.*
        *   Construct the `pytest` command: `command = "pytest"`, `args = [mounted_test_path, "-v"]` (add other useful pytest args like `-s`).
    *   **Execute Pytest via `executeCommand`:**
        *   Prepare `params` for the `core.linux.executeCommand` tool, including the `pytest` command and arguments. **Important:** The execution context *must* target the *allocated sandbox container*. This requires a mechanism for the `CoreMCPServer` (where `executeCommand` logic lives) to direct execution to a *specific container*. This might involve:
            *   Passing the `containerId` from `allocate_sandbox` response to the `executeCommand` params.
            *   The `executeCommand` implementation using `docker exec {containerId} {command} ...` instead of running locally.
            *   *Add a TODO comment here to implement this targeted execution logic in `handle_linux_execute_command`.*
        *   Call `await handle_linux_execute_command(execute_params, state_manager, app_registry, context)` (calling the local handler function directly).
    *   **Process Results:**
        *   Check the `exitCode` from the `executeCommand` response. `0` means success.
        *   Extract combined `stdout` and `stderr` as the `output`.
    *   **Release Sandbox:** Ensure the allocated sandbox is released using `sandbox_manager.release_sandbox()` in a `finally` block.
    *   **Return Response:** Format the response based on test success/failure (`success: True/False`, `output: pytest_output`).
4.  **Register Handler:** Add `"core.testing.runPytestInSandbox": handle_run_pytest_in_sandbox` to the `TOOL_HANDLERS` dictionary.
5.  **Add Tests:** Use `write_to_file` to add tests in `tests/mcp_servers/core/test_server.py`:
    *   Mock `SandboxManager`, `StateManager`, internal call to `handle_linux_execute_command`.
    *   Test successful test run scenario.
    *   Test scenario where `allocate_sandbox` fails.
    *   Test scenario where `executeCommand` (mocked) returns non-zero exit code.
6.  **Save Changes:** Use `write_to_file` to save the modified `@mcp_servers/core/server.py` and test file.

**Expected Outcome:**
*   The `core.testing.runPytestInSandbox` MCP tool is implemented (handler + schemas).
*   It utilizes `SandboxManager` and relies on a (TODO) modification to `core.linux.executeCommand` to target specific containers.
*   Tests for the new tool handler are added.