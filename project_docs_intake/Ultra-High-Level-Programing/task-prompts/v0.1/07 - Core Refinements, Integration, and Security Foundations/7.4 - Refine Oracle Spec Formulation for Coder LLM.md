## Goal: Refine OptimizationOracle's JIT Spec Formulation

Enhance the `_trigger_jit_generation` method in `@core/optimization/optimization_oracle.py` to generate a more detailed and effective specification prompt for the Coder LLM, leveraging metadata from the prompt template.

**Context:**
*   Oracle Code: `@core/optimization/optimization_oracle.py` (specifically `_trigger_jit_generation`)
*   Dependencies: `StateManagerInterface`, `CoreMCPServer` (`core.llm.generate`), `PyYAML` (add if needed).
*   Prompt Template Schema: `@schemas/prompt_template.schema.json` (includes `description`, `outputSchema`, etc.)
*   Design Docs: `07-jit-optimization.md` [10], Section 7.3.1 [10].

**Plan:**

1.  **Add Dependency:** Ensure `PyYAML` is in `@requirements.txt` and installed if not already.
2.  **Read Oracle Code:** Use `read_file` to load `@core/optimization/optimization_oracle.py`.
3.  **Modify `_trigger_jit_generation` - Spec Formulation Section:**
    *   **Fetch Prompt Template:** Fetch the template content using `state_manager.get_definition_file_content` as before.
    *   **Parse YAML Metadata:** Use `yaml.safe_load()` to parse the fetched template string. This assumes the template file contains YAML front matter or is pure YAML. Extract:
        *   `description = template_yaml.get('description', '')`
        *   `output_schema = template_yaml.get('outputSchema')` (This should be a JSON schema dict)
        *   `parameters = template_yaml.get('parameters', {})`
        *   `template_text = template_yaml.get('template', '')`
        *   Handle parsing errors. If pure Jinja, skip parsing and rely only on description/schema potentially passed in `ComponentDefinition`'s `taskDetails`? *Clarify assumption: Template file is YAML containing metadata + template string.*
    *   **Construct Detailed Prompt:** Build the prompt string for the Coder LLM, including sections for:
        *   **`Purpose:`**: Use the parsed `description`.
        *   **`Target Language:`**: Specify Python (or configured language).
        *   **`Input Context:`**: Describe the expected input structure (equivalent to the Jinja2 context: `requestData`, `context`). Define expected keys/types if possible.
        *   **`Core Logic:`**: Include the actual `template_text` as a reference for the LLM, explaining it represents the logic to be implemented.
        *   **`Output Requirements:`**:
            *   State the required output format (e.g., JSON).
            *   **Crucially:** If `output_schema` was present, include it directly in the prompt: `"The output MUST conform precisely to the following JSON Schema:\n\`\`\`json\n{json.dumps(output_schema, indent=2)}\n\`\`\`"`. This significantly guides the Coder LLM.
        *   **`Function Signature:`**: Suggest a Python function signature (e.g., `async def handle_request(input_data: dict, context: dict) -> dict:`).
        *   **`Dependencies:`**: Mention that standard libraries and allowed MCP tools (via dependency injection?) can be used. Forbid direct external calls.
        *   **`Testing Requirement:`**: **Explicitly instruct the LLM to generate comprehensive unit tests using `pytest`** for the generated function, including mocking any necessary external interactions (like potential MCP calls if the JIT code needs them). Request varied test cases (happy path, edge cases, error conditions).
        *   **`Output Format:`**: Instruct the LLM to respond with a specific format, e.g., a JSON object containing `"code"` and `"tests"` keys.
4.  **Update Coder LLM Call:** Ensure the `params` for `core.llm.generate` includes this new detailed prompt and potentially requests JSON output format from the Coder LLM.
5.  **Add Imports:** Ensure `yaml`, `json` are imported.
6.  **Save Changes:** Use `write_to_file` to save the updated `@core/optimization/optimization_oracle.py`.

**Expected Outcome:**
*   The `OptimizationOracle` now constructs a significantly more detailed prompt for the Coder LLM, incorporating metadata (description, output schema) from the original prompt template and explicitly requesting `pytest` unit tests.