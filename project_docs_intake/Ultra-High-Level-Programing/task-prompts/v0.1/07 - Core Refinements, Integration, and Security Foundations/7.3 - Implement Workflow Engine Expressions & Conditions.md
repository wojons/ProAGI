## Goal: Enhance Workflow Engine with Basic Expression/Condition Evaluation

Implement basic expression evaluation (using `jsonpath-ng`) for `inputMapping` and conditional transitions (`conditionalTransitions.condition`) within the workflow engine in `@sandbox_images/python_runner/sandbox_server.py`.

**Context:**
*   Sandbox Server Code: `@sandbox_images/python_runner/sandbox_server.py` (specifically `_execute_workflow` and `_evaluate_jsonpath`).
*   Dependency: `jsonpath-ng` (Ensure it's in requirements).
*   Design Docs: `05-workflow-yaml.md` [8, 21] (describes `inputMapping`, `conditionalTransitions`).

**Plan:**

1.  **Read Sandbox Server Code:** Use `read_file` to load `@sandbox_images/python_runner/sandbox_server.py`.
2.  **Refine `_evaluate_jsonpath` Helper:**
    *   Replace the placeholder implementation.
    *   Take `expression: str` (the JSONPath string like `$.input.user.id`) and `context_data: dict` (the `workflow_context`) as input.
    *   Use `jsonpath_ng.parse(expression).find(context_data)` to find matches.
    *   Handle cases: No match (return `None` or raise specific error?), multiple matches (return list of values or first value? Decide and implement - V1: return first value's `.value`), single match (return `.value`).
    *   Wrap in `try...except` to catch `jsonpath_ng` parsing errors and lookup failures, logging errors and returning `None` or raising.
3.  **Integrate into Input Mapping:**
    *   In `_execute_workflow`, within the loop where `inputMapping` is processed:
        *   Iterate through `step_def.get('inputMapping', {}).items()`.
        *   For each `targetVar, sourceExpression` pair, call `value = _evaluate_jsonpath(sourceExpression, workflow_context)`.
        *   Assign `step_input_data[targetVar] = value`. Handle cases where `value` is `None` if necessary based on requirements.
4.  **Implement Conditional Transition Evaluation:**
    *   In `_execute_workflow`, within the transition logic after a step succeeds:
        *   Iterate through `step_def.get('transitions', {}).get('conditionalTransitions', [])`.
        *   For each `transition` object (`condition`, `nextStepId`):
            *   Parse the `condition` string. Assume a simple format for V1 like: `"{jsonpath_expression} {operator} {value}"` (e.g., `"$.steps.current.output.status == 'COMPLETED'"` or `"$.steps.current.output.amount > 100"`). *Add validation for this format.*
            *   Extract the `jsonpath_expression`, `operator` (e.g., `==`, `>`, `<`, `!=`), and `value` (string or number).
            *   Evaluate the `jsonpath_expression` using `_evaluate_jsonpath(expression, workflow_context)` to get the `actual_value` from the workflow state.
            *   Compare `actual_value` with the literal `value` using the specified `operator`. Handle type conversions carefully (e.g., string vs number).
            *   If the condition evaluates to `True`: set `current_step_id = transition['nextStepId']`, set a flag `transition_taken = True`, and `break` the loop over conditional transitions.
        *   Ensure the logic falls through to `onSuccess` only if `transition_taken` is `False`.
5.  **Add Imports:** Ensure `jsonpath_ng` is imported.
6.  **Save Changes:** Use `write_to_file` to save the updated `@sandbox_images/python_runner/sandbox_server.py`.

**Expected Outcome:**
*   The workflow engine now uses `jsonpath-ng` (or similar basic mechanism) to map data based on `inputMapping`.
*   Conditional transitions are evaluated based on simple comparisons against values extracted from the workflow context using JSONPath.