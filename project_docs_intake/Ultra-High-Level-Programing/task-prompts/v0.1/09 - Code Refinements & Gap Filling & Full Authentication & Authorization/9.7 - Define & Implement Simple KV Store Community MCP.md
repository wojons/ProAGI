# Task 9.7: Define & Implement Simple KV Store Community MCP

**Goal:** Implement a basic Community MCP server providing simple key-value storage tools (`community.database.simple_kv.set`, `get`, `delete`), potentially using Redis as the backend (but accessed *via* this MCP, not directly by sandboxes).

**Context:**
- MCP Design: `@.clinerules/04-mcp-design.md` [7]
- MCP Core Server: `@mcp_servers/core/server.py` (for reference on structure)
- Backend: Use `redis.asyncio` client (ensure `redis` is in root `requirements.txt`).

**Plan:**

1.  **Create MCP Server Directory:** Use `write_to_file` to create `mcp_servers/community/simple_kv/`.
2.  **Define Tool Schemas:** Use `write_to_file` to create schema files in the new directory:
    *   `community.database.simple_kv.set.input.schema.json`: Requires `key` (string), `value` (any JSON type).
    *   `community.database.simple_kv.set.output.schema.json`: Empty object `{}`.
    *   `community.database.simple_kv.get.input.schema.json`: Requires `key` (string).
    *   `community.database.simple_kv.get.output.schema.json`: Contains optional `value` (any JSON type).
    *   `community.database.simple_kv.delete.input.schema.json`: Requires `key` (string).
    *   `community.database.simple_kv.delete.output.schema.json`: Contains `deleted` (boolean).
3.  **Implement Server (`server.py`):** Use `write_to_file` to create `mcp_servers/community/simple_kv/server.py`.
    *   Adapt the structure from `@mcp_servers/core/server.py`.
    *   Import `aiohttp`, `redis.asyncio`, `logging`, `json`, `jsonschema`.
    *   **Dependencies:** Initialize `redis.asyncio` connection pool (should be configured via env vars specific to this MCP server/app).
    *   **Tool Handlers:** Implement `async` handlers for `set`, `get`, `delete`:
        *   Handlers receive `params` and `context` (`appId` needed for namespacing).
        *   Use `redis_client.set(f"uhlp:community_kv:{appId}:{key}", json.dumps(value))`.
        *   Use `redis_client.get(...)` and `json.loads(...)`. Handle key not found for `get`.
        *   Use `redis_client.delete(...)`.
        *   Return data matching the output schemas.
    *   **Main Handler & Server Setup:** Implement the main `handle_mcp_request` (similar to Core MCP) to parse request, validate against *MCP standard request schema*, look up handlers *specific to this server* (`set`, `get`, `delete`), validate *tool-specific input params*, call handler, handle errors, format response using *MCP standard response schema*. Add `/healthz`.
4.  **Add Basic Tests:** Use `write_to_file` to create `tests/mcp_servers/community/test_simple_kv_server.py`.
    *   Use `aiohttp.pytest_plugin`.
    *   Mock the `redis.asyncio` client.
    *   Test successful calls to `set`, `get` (found/not found), `delete`.
    *   Test invalid requests (bad JSON, missing tool, invalid params).
5.  **Dockerfile (Optional):** Create `mcp_servers/community/simple_kv/Dockerfile` to containerize this server. Include `redis` library in its `requirements.txt`.

**Expected Outcome:** A deployable Community MCP server for simple KV operations, with schemas and basic tests. Core Framework routing needs updating (V2+) to direct calls here.