# Task 8.2: JIT Optimization Cycle Integration Test

**Goal:** Create an integration test for the end-to-end JIT optimization cycle managed by `@core/optimization/optimization_oracle.py`.

**Context:**
- Oracle Logic: `@core/optimization/optimization_oracle.py` (`run_optimization_cycle`, `_trigger_jit_generation`)
- Dependencies (to mock): `@core/interfaces/application_registry_interface.py`, `@core/interfaces/state_manager_interface.py`, `@core/interfaces/metric_collector_interface.py`, `MCPClient` (for `core.llm.generate`, `core.testing.runPytestInSandbox`).
- Data Models: `@core/shared/data_models.py`
- Testing Standards: `@.clinerules/09-testing.md` [12]
- JIT Standards: `@.clinerules/07-jit-optimization.md` [10]
- MCP Tool Schemas

**Plan:**

1.  **Analyze:** Read `@core/optimization/optimization_oracle.py`. Understand the flow: Check Apps -> Check Components -> Check Metrics/Rules -> Formulate Spec -> Call Coder LLM -> Store Artifacts -> Run Tests -> Update Registry.
2.  **Create Test File:** Use `write_to_file` to create `tests/core/optimization/test_oracle_integration.py`.
3.  **Setup Mocks:** Create `AsyncMock` instances for `ApplicationRegistryInterface`, `StateManagerInterface`, `MetricCollectorInterface`, and `MCPClient`.
4.  **Configure Happy Path Mocks:**
    *   `mock_app_registry.list_application_ids`: Return `['test-app']`.
    *   `mock_app_registry.get_application_definition`: Return a mock `AppDefinition` for `test-app` containing an LLM component (`comp-opt`) with optimization rules set, and its `runtimeConfig` specifying the JIT pool name.
    *   `mock_metric_collector.query_metric`: Return values that WILL trigger the optimization rules for `comp-opt`.
    *   `mock_state_manager.get_definition_file_content`: Return mock YAML/template content when asked for the prompt template and the component registry file.
    *   `mock_mcp_client.call_tool (core.llm.generate)`: Return a valid JSON string containing mock `"code"` and `"tests"` strings.
    *   `mock_mcp_client.call_tool (core.testing.runPytestInSandbox)`: Return `{"success": True, "output": "Tests passed"}`.
    *   `mock_state_manager.set_definition_file_content`: Mock successful saving of code, tests, and updated registry.
5.  **Test Full Cycle Success:** Write a test function (`test_optimization_cycle_e2e_success`) that instantiates the `OptimizationOracle` with mocks and calls `run_optimization_cycle`.
    *   **Assert:**
        *   `mock_metric_collector.query_metric` was called.
        *   `mock_mcp_client.call_tool` was called for `core.llm.generate`.
        *   `mock_state_manager.set_definition_file_content` was called 3 times (code, tests, registry). Verify file paths and commit messages.
        *   `mock_mcp_client.call_tool` was called for `core.testing.runPytestInSandbox`. Verify params (`test_file_path`, `target_pool_name`).
        *   Verify the content passed to the *final* `set_definition_file_content` call (the registry update) shows `comp-opt` changed to `handlerType: JIT` with correct `taskDetails` pointing to the new script path.
6.  **Test Test Failure Scenario:** Write `test_optimization_cycle_test_fail`. Configure `mock_mcp_client.call_tool (core.testing.runPytestInSandbox)` to return `{"success": False, ...}`.
    *   **Assert:**
        *   Code/Test artifacts were saved (`set_definition_file_content` called twice).
        *   The final state update (`set_definition_file_content` for registry) was *NOT* called.
7.  **Test LLM Failure Scenario:** Write `test_optimization_cycle_llm_fail`. Configure `mock_mcp_client.call_tool (core.llm.generate)` to raise an `MCPError`.
    *   **Assert:**
        *   `mock_state_manager.set_definition_file_content` was *NOT* called at all.
        *   `mock_mcp_client.call_tool (core.testing.runPytestInSandbox)` was *NOT* called.
8.  **Test Rule Not Met / Prefer LLM Scenario:** Write tests where `query_metric` returns values below threshold, or `prefer_llm_flexibility` is true.
    *   **Assert:** `_trigger_jit_generation` (and thus subsequent MCP/State calls) are *NOT* called.

**Expected Outcome:** Integration tests in `tests/core/optimization/test_oracle_integration.py` verifying the JIT optimization workflow under different conditions.