# Task 8.1: Workflow Engine Integration Tests

**Goal:** Create integration tests for the workflow engine implemented in `@sandbox_images/python_runner/sandbox_server.py`.

**Context:**
- Workflow Engine Logic: `@sandbox_images/python_runner/sandbox_server.py` (function `_execute_workflow`)
- Workflow Schema: `@schemas/workflow_definition.schema.json`
- Workflow Standards: `@.clinerules/05-workflow-yaml.md` [8]
- Testing Standards: `@.clinerules/09-testing.md` [12]
- Sandbox Server: `@sandbox_images/python_runner/sandbox_server.py` (needs to be run/mocked)
- MCP Client: `MCPClient` class in `@sandbox_images/python_runner/sandbox_server.py`
- Core MCP Tools (to mock): `core.state.getDefinitionFileContent`, `core.llm.generate` (mock responses), `core.linux.executeCommand` (mock responses for JIT calls)

**Plan:**

1.  **Analyze:** Read `@sandbox_images/python_runner/sandbox_server.py` focusing on `_execute_workflow`, `_evaluate_jsonpath`, and conditional logic. Review `@schemas/workflow_definition.schema.json` and `@.clinerules/05-workflow-yaml.md` [8].
2.  **Create Test File:** Use `write_to_file` to create `tests/sandbox/test_workflow_engine.py`.
3.  **Test Basic Flow:** Write `pytest` tests using `unittest.mock.AsyncMock` to mock the `MCPClient`. Define simple mock workflow YAML structures (as Python dicts). Test:
    *   Loading the workflow definition via mocked MCP.
    *   Executing a linear workflow (e.g., MCP -> LLM -> MCP).
    *   Correct data passing between steps via `inputMapping` (using mocked `_evaluate_jsonpath` initially or testing it separately).
    *   Successful termination with `end: true`.
    *   Correct final `resultType` and `data` for `control.formatResponse` step.
4.  **Test Conditional Transitions:** Write tests verifying conditional logic (`conditionalTransitions`):
    *   Test transitions based on `step.output.result == 'value'` using mocked step outputs.
    *   Test transitions based on `step.output.error.code` using mocked step failures.
    *   Test default `onSuccess` path when conditions don't match.
5.  **Test Failure Handling:** Write tests for:
    *   `onFailureDefault` transition when a step fails (mock an `MCPError` during execution).
    *   Workflow termination with error when a step fails and no `onFailureDefault` exists.
    *   Handling `max_steps` limit violation.
6.  **Test Input Mapping:** Write specific tests (or test `_evaluate_jsonpath` directly) covering:
    *   Accessing `trigger.*`, `steps.<id>.output.*`, `context.*`.
    *   Handling missing paths (should return `None` or error based on `_evaluate_jsonpath` implementation).
    *   Using literal values in mappings.
7.  **Refine & Document:** Ensure tests follow standards from `@.clinerules/09-testing.md` [12] (fixtures, clear assertions, mocking). Add docstrings.

**Expected Outcome:** A suite of integration tests in `tests/sandbox/test_workflow_engine.py` covering the core logic, transitions, error handling, and input mapping of the workflow engine.