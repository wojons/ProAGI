# Task 8.4: Harden core.linux.executeCommand Wrappers

**Goal:** Follow up on the TODO from Task 6.5 (`@mcp_servers/core/server.py`) by implementing basic hardened wrappers for potentially risky commands allowed by `core.linux.executeCommand` (e.g., `echo`, `ls`, `cat`, `pytest` if added).

**Context:**
- MCP Server: `@mcp_servers/core/server.py` (handler `handle_linux_execute_command`)
- Security Rules: `@.clinerules/08-security.md` [11, 25], `@.design-docs/10 - Security Considerations.md` (Section 10.2 [11, 25])
- Current Implementation: Uses whitelist and direct execution (possibly via `docker exec`).

**Plan:**

1.  **Analyze:** Read the `handle_linux_execute_command` function in `@mcp_servers/core/server.py`. Identify the current whitelist (`COMMAND_WHITELIST`) and execution logic (local subprocess or `docker exec`).
2.  **Identify Wrapper Candidates:** From the whitelist (`echo`, `ls`, `cat`, `pytest`), determine which might benefit from argument validation/sanitization (even basic ones). `pytest` is a key candidate. `echo`, `ls`, `cat` are less risky but could still potentially have problematic flags or path arguments.
3.  **Implement Basic Validation:** Modify the `handle_linux_execute_command` function. *Before* executing the command (either locally or via `docker exec`):
    *   Add checks based on the `command` name.
    *   **`echo`:** Allow only basic alphanumeric arguments, possibly disallow common shell metacharacters (like `;`, `|`, `&`, `$`, `` ` ``) within args, although `shell=False` should prevent interpretation.
    *   **`ls`, `cat`:** Perform stricter validation on path arguments in `args`. Ensure they are relative paths, do not contain `..`, and potentially restrict allowed characters. Check against application-specific scoping if `core.filesystem.*` rules are defined.
    *   **`pytest`:** Validate arguments. Disallow potentially dangerous pytest options (`--capture=no`). Ensure the target test path (`args[-1]`) looks like a valid path within the expected `/state/<app_id>/...` structure.
    *   If validation fails, raise `PermissionError` with a descriptive message.
4.  **Log Validation:** Add detailed logging indicating which validation checks were performed and whether they passed or failed.
5.  **Refactor:** Ensure validation logic doesn't overly clutter the main execution flow (use helper functions).
6.  **Update Tests:** Modify tests in `tests/mcp_servers/core/test_server.py` for `executeCommand`:
    *   Add tests that attempt to call whitelisted commands with potentially risky arguments (e.g., `ls /etc`, `cat ../../file`, `pytest --capture=no`).
    *   Assert that these calls raise `PermissionError` (resulting in a 403 response).
    *   Ensure existing success tests still pass with valid arguments.

**Expected Outcome:** The `handle_linux_execute_command` handler includes additional argument validation/sanitization steps for whitelisted commands before execution, reducing potential risks. Tests verify this hardening.