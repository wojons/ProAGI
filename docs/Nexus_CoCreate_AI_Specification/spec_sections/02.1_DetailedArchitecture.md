### 2.1 Detailed Architecture (MVP Focus)

**Purpose:** This section provides a more detailed description of the core components of the Nexus CoCreate AI system, expanding on the high-level overview and outlining their specific responsibilities, internal workings, and interactions, with a focus on the lean implementation for the Minimum Viable Product (MVP) / Proof of Concept (POC). The architecture is based on the principles of the UHLP Immutable Core Framework.

The backend is built around a Core Framework providing essential services, implemented in a lean, functional manner for the MVP. All frontend UI actions communicate with a well-defined backend API (RESTful HTTP or simple RPC for POC).

**2.1.1 ApplicationRegistry Internal API Specification (Version 1.0 - MVP Focus)**

#### 2.1.1.1 Purpose & Transport (gRPC)

The `ApplicationRegistry` serves as the central nervous system and source of truth for managing the lifecycle, definition, configuration, and security context of all Nexus CoCreate AI applications hosted by the framework instance. It persists application definitions (potentially caching them from the primary Git/YAML state store or managing their registration) and exposes a queryable interface for other components. It is the authoritative source for information required by the `SandboxManager` to provision resources, the `RequestRouter` to make routing decisions, and MCP servers to enforce permissions and find configurations.

For the **MVP**, its primary role is to manage a basic `AppDefinition` for each project.

**Transport Protocol:** Internal gRPC is preferred for efficient, strongly-typed communication between core framework services.

**Service Name:** `nexus.cocreate.ai.framework.ApplicationRegistryService`

#### 2.1.1.2 Methods (Application Lifecycle & Management)

These methods handle the creation, modification, and removal of applications within the framework's purview.

*   **`RegisterApplication`**
    *   **Purpose:** Registers a new Nexus CoCreate AI application, making it known to the framework and initiating resource provisioning (via interaction with `SandboxManager`). Typically called during the application bootstrap process initiated via the Admin Panel.
    *   **Request:** `RegisterApplicationRequest` (See Data Models Section 4.7 for `AppDefinition` structure)
        ```protobuf
        message RegisterApplicationRequest {
          AppDefinition definition = 1; // Full application definition, likely sourced from initial user input/config files.
        }
        ```
    *   **Response:** `RegisterApplicationResponse`
        ```protobuf
        message RegisterApplicationResponse {
          string appId = 1; // Confirmed App ID
          bool success = 2;
          optional string error = 3; // Describes failure reason if success is false
        }
        ```

*   **`UpdateApplication`**
    *   **Purpose:** Applies partial updates to an existing application's definition (e.g., changing sandbox requirements, updating a component definition, modifying configuration or security rules). Typically triggered via the Admin Panel.
    *   **Request:** `UpdateApplicationRequest`
        ```protobuf
        message UpdateApplicationRequest {
          string appId = 1;
          // Uses field masks (`google.protobuf.FieldMask`) to specify which parts of the AppDefinition are being updated.
          google.protobuf.FieldMask update_mask = 2;
          AppDefinition updated_definition_fields = 3; // Contains only the fields specified in the mask
        }
        ```
    *   **Response:** `UpdateApplicationResponse`
        ```protobuf
        message UpdateApplicationResponse {
          bool success = 1;
          optional string error = 2;
        }
        ```

*   **`DeregisterApplication`**
    *   **Purpose:** Deactivates or completely removes an application from framework management. This should signal the `SandboxManager` to terminate associated sandboxes and potentially clean up state.
    *   **Request:** `DeregisterApplicationRequest`
        ```protobuf
        message DeregisterApplicationRequest {
          string appId = 1;
          bool deleteState = 2; // Flag to indicate if persistent state (e.g., Git repo) should also be removed. Defaults to false.
        }
        ```
    *   **Response:** `DeregisterApplicationResponse`
        ```protobuf
        message DeregisterApplicationResponse {
          bool success = 1;
          optional string error = 2;
        }
        ```

*   **`GetApplicationStatus`**
    *   **Purpose:** Retrieves the current runtime status of an application (e.g., Active, Inactive, Degraded, Error), potentially querying `SandboxManager` or health checks.
    *   **Request:** `GetApplicationStatusRequest`
        ```protobuf
        message GetApplicationStatusRequest {
          string appId = 1;
        }
        ```
    *   **Response:** `GetApplicationStatusResponse`
        ```protobuf
        message GetApplicationStatusResponse {
          string appId = 1;
          AppStatus status = 2;
          optional string details = 3; // e.g., Error message, number of running instances
        }
        enum AppStatus { APP_STATUS_UNSPECIFIED = 0; APP_STATUS_ACTIVE = 1; APP_STATUS_INITIALIZING = 2; APP_STATUS_INACTIVE = 3; APP_STATUS_DEGRADED = 4; APP_STATUS_ERROR = 5; }
        ```

*   **`ListActiveApplications`**
    *   **Purpose:** Returns IDs of all applications currently managed by the framework and considered active and running. Crucial for `SandboxManager` to know which applications require resources.
    *   **Request:** `ListActiveApplicationsRequest` (Empty)
    *   **Response:** `ListActiveApplicationsResponse`
        ```protobuf
        message ListActiveApplicationsResponse {
          repeated string appIds = 1;
        }
        ```

#### 2.1.1.3 Methods (Configuration & Requirements Retrieval)

These methods provide read access to the detailed configuration and requirements of specific applications, used heavily by other framework components.

*   **`GetApplicationDetails`**
    *   **Purpose:** Retrieves the complete, current `AppDefinition` structure for a specific application.
    *   **Request:** `GetApplicationDetailsRequest`
        ```protobuf
        message GetApplicationDetailsRequest {
          string appId = 1;
        }
        ```
    *   **Response:** `GetApplicationDetailsResponse`
        ```protobuf
        message GetApplicationDetailsResponse {
          AppDefinition definition = 1; // The full application definition object
        }
        ```

*   **`GetSandboxRequirements`**
    *   **Purpose:** Provides the specific sandbox pool configuration (`SandboxPoolConfig`) needed for an application. Primarily used by the `SandboxManager` to know what Docker images, sizes, and settings to use for provisioning.
    *   **Request:** `GetSandboxRequirementsRequest`
        ```protobuf
        message GetSandboxRequirementsRequest {
          string appId = 1;
        }
        ```
    *   **Response:** `GetSandboxRequirementsResponse`
        ```protobuf
        message GetSandboxRequirementsResponse {
          string appId = 1;
          SandboxPoolConfig requirements = 2; // Corresponds to AppDefinition.sandboxPools
        }
        ```

*   **`GetComponentDefinition`**
    *   **Purpose:** Retrieves the handling details for a specific component within an application, matched either by its unique `componentId` or by an incoming route (path + method). Primarily used by the `RequestRouter` to determine how to handle an incoming request/event.
    *   **Request:** `GetComponentDefinitionRequest`
        ```protobuf
        message GetComponentDefinitionRequest {
          string appId = 1;
          oneof identifier {
            string componentId = 2;   // Lookup by component ID directly
            RouteMatchInput routeInput = 3; // Lookup by matching HTTP route pattern
          }
        }
        message RouteMatchInput { string path = 1; /* Raw request path */ string method = 2; /* HTTP method */ }
        ```
    *   **Response:** `GetComponentDefinitionResponse`
        ```protobuf
        message GetComponentDefinitionResponse {
          bool found = 1; // Was a matching component definition found?
          optional ComponentDefinition definition = 2; // The definition if found
          optional map<string, string> extractedPathParameters = 3; // If lookup was by route, contains extracted params (e.g., {"id": "123"})
        }
        ```

*   **`GetAppConfigurationValue`**
    *   **Purpose:** Retrieves a specific configuration value associated with an application, potentially merging global, app-level, and component-level configurations. Useful for components needing specific settings (e.g., an LLM client needing an API base URL) and accessible to sandboxes via the `core.framework.getConfigValue` MCP tool.
    *   **Request:** `GetAppConfigurationValueRequest`
        ```protobuf
        message GetAppConfigurationValueRequest {
          string appId = 1;
          string key = 2; // Key to retrieve (e.g., "llm.provider", "externalServices.email.apiKey")
          optional string componentId = 3; // Optional context for component-specific overrides
        }
        ```
    *   **Response:** `GetAppConfigurationValueResponse`
        ```protobuf
        message GetAppConfigurationValueResponse {
          string key = 1;
          bool found = 2;
          optional google.protobuf.Value value = 3; // Standard proto type for arbitrary JSON-like value (string, number, bool, object, array)
        }
        ```

#### 2.1.1.4 Methods (Security: Validation & Permissions Retrieval)

These methods support the framework's security model, allowing validation of credentials and retrieval of permission sets.

*   **`ValidateApiKey`**
    *   **Purpose:** Checks if a provided API key is valid for any registered application and returns its associated application ID and permissions. Used by ingress/authentication layers.
    *   **Request:** `ValidateApiKeyRequest`
        ```protobuf
        message ValidateApiKeyRequest {
          string apiKey = 1; // The raw API key provided by the client
        }
        ```
    *   **Response:** `ValidateApiKeyResponse`
        ```protobuf
        message ValidateApiKeyResponse {
          bool isValid = 1;
          optional string appId = 2; // The Application ID the key belongs to, if valid
          repeated string permissions = 3; // List of permissions granted by this key, if valid
        }
        ```
    *   *Security Note:* Internally, this service MUST hash the input `apiKey` using a secure, one-way hashing algorithm (like Argon2 or bcrypt) with appropriate salts and compare it against stored hashes in the `SecurityConfig` for registered applications. Plaintext keys should never be stored.

*   **`GetApplicationPermissions`**
    *   **Purpose:** Retrieves the defined permission rules governing the application itself, such as which other applications are allowed to trigger it or which external services it can interact with. Potentially used by `RequestRouter` or MCP servers for authorization checks.
    *   **Request:** `GetApplicationPermissionsRequest`
        ```protobuf
        message GetApplicationPermissionsRequest {
          string appId = 1;
        }
        ```
    *   **Response:** `GetApplicationPermissionsResponse`
        ```protobuf
        message GetApplicationPermissionsResponse {
          // Structure mirrorring relevant parts SecurityConfig, e.g.,
          repeated InterAppPermission interAppPermissions = 1;
          // Could also include outbound permissions, etc.
        }
        ```

*   **`GetUserPermissionsForApp`**
    *   **Purpose:** Retrieves the specific permissions a given user has within the context of a specific application, based on their assigned roles. Used to populate the `context.userInfo`<thinking>
I have successfully updated `docs/Nexus_CoCreate_AI_Specification/spec_sections/02.1_DetailedArchitecture.md` with the technical backend details from Section 6 of the new MVP/POC document.

I have now integrated the content from Sections 1, 2, 3, 4, 5, and 6 of the "Nexus CoCreate AI - Comprehensive MVP/POC Design Specification.md" into the existing Nexus CoCreate AI Specification documentation.

The MVP/POC document also includes an "Out of Scope for Initial MVP/POC" section. This information is relevant to `docs/Nexus_CoCreate_AI_Specification/spec_sections/08.0_FutureWork.md`, which I previously updated with future work considerations from UHLP 11. I should ensure the "Out of Scope" items from the MVP document are clearly noted, potentially within the introduction or a dedicated subsection in the Future Work file, to distinguish them from broader V2+ ideas.

I will update `docs/Nexus_CoCreate_AI_Specification/spec_sections/08.0_FutureWork.md` to include the specific "Out of Scope" items from the MVP/POC document. I will add a new subsection for MVP/POC Exclusions.

I will use `write_to_file` to update this file. I will read the current content of the file first to ensure I'm appending to the correct location and preserving existing content.
</thinking>
<read_file>
<path>docs/Nexus_CoCreate_AI_Specification/spec_sections/08.0_FutureWork.md</path>
</read_file>
